## SUMMARY MAP

ğŸ“ supabase/
  Purpose: Configuration and local development files for Supabase.
  Details: This directory typically holds CLI-generated files, migrations, and project-specific Supabase settings.
  â”œâ”€â”€ ğŸ“„ config.toml
  â”‚   Purpose: Main configuration file for the Supabase CLI, overriding default behaviors and specifying project structure.
  â”‚   Details:
  â”‚   - Defines function-specific settings for `clarify-user-intent`.
  â”‚   - `entrypoint`: Specifies the direct path to the main `index.ts` file for the `clarify-user-intent` function, relative to the `supabase` directory itself (e.g., `../src/backend/functions/clarify-user-intent/index.ts`). This tells the CLI where to find the function code if it's not in the default `supabase/functions` location.
  â”‚   - `import_map`: Specifies the path to the `import_map.json` file used by Deno for this function, also relative to the `supabase` directory (e.g., `../src/backend/functions/import_map.json`). This ensures correct module resolution during bundling and deployment.
  â”‚   - **Also defines similar `entrypoint` and `import_map` settings for the `generate-email-changes` function.**
  â”‚   Usage: Crucial for deploying Edge Functions when they are not located in the default `supabase/functions` directory. Ensures the Supabase CLI can locate the function code and its dependencies correctly.

ğŸ“ src/
â”œâ”€â”€ ğŸ“ backend/
â”‚   â”œâ”€â”€ ğŸ“ functions/
â”‚   â”‚   â”œâ”€â”€ ğŸ“ stripe-webhook-handler/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ index.ts
â”‚   â”‚   â”‚   â”‚   Purpose: Handles Stripe webhook events for subscription management.
â”‚   â”‚   â”‚   â”‚   Details:
â”‚   â”‚   â”‚   â”‚   - Processes various Stripe events (checkout.session.completed, invoice events, subscription updates).
â”‚   â”‚   â”‚   â”‚   - Updates user subscription status and tier in Supabase database.
â”‚   â”‚   â”‚   â”‚   - Handles subscription lifecycle (creation, updates, cancellation).
â”‚   â”‚   â”‚   â”‚   - Integrates with Stripe API and Supabase client.
â”‚   â”‚   â”‚   â”‚   Usage: Deployed as Supabase Edge Function to handle Stripe webhook notifications.
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ types.ts
â”‚   â”‚   â”‚       Purpose: Type definitions for subscription-related data.
â”‚   â”‚   â”‚       Details:
â”‚   â”‚   â”‚       - Defines `SubscriptionTier` type ('free' | 'pro' | 'premium').
â”‚   â”‚   â”‚       - Defines `SubscriptionPlan` interface.
â”‚   â”‚   â”‚       - Provides utility function `determineTierFromPriceId`.
â”‚   â”‚   â”‚       Usage: Used by webhook handler and other subscription-related components.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“ .temp/  
â”‚   â”‚   â”‚   Purpose: Supabase CLI version tracking or temporary build files for backend.
â”‚   â”‚   â”‚   Details: (Clarify based on actual use)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“ functions/ 
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ _shared/
â”‚   â”‚   â”‚   â”‚   Purpose: Contains shared code, types, or utilities used by multiple backend functions.
â”‚   â”‚   â”‚   â”‚   Details: For example, `cors.ts` for CORS headers, `lib/` for more complex shared utilities.
â”‚   â”‚   â”‚   â”‚   Usage: Imported by other functions to reduce code duplication.
â”‚   â”‚   â”‚   â”‚   Files:
â”‚   â”‚   â”‚   â”‚     *   **`cors.ts`**
â”‚   â”‚   â”‚   â”‚         *   Purpose: Provides basic Cross-Origin Resource Sharing (CORS) headers for Deno functions.
â”‚   â”‚   â”‚   â”‚         *   Details: Exports a `corsHeaders` object: `{"Access-Control-Allow-Origin": "*", "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type", "Access-Control-Allow-Methods": "POST, GET, OPTIONS"}`. The wildcard origin is suitable for development but should be more restrictive in production.
â”‚   â”‚   â”‚   â”‚         *   Usage: Imported directly by Deno functions (e.g., `save-email-setup-form`) for simple OPTIONS request handling and adding permissive CORS headers.
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ lib/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ constants.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   Purpose: Manages Cross-Origin Resource Sharing (CORS) configuration for Supabase Edge Functions, ensuring secure API access.
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   Details:
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   - Defines a whitelist of `ALLOWED_ORIGINS` for production (monketer.com, www.monketer.com) and common development ports (localhost:3000, localhost:5173, localhost:8080).
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   - Exports `corsHeadersFactory(requestOrigin)`: A function that dynamically generates appropriate CORS headers. It returns the `requestOrigin` if it's in `ALLOWED_ORIGINS`, otherwise defaults to the primary production origin. This is the recommended method.
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   - Specifies allowed HTTP headers (authorization, x-client-info, apikey, content-type) and methods (GET, POST, PUT, DELETE, OPTIONS).
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   - Sets `Access-Control-Max-Age` to `86400` (24 hours) for preflight request caching.
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   - Includes legacy `corsHeaders` with a wildcard `Access-Control-Allow-Origin: '*'`, which is deprecated but maintained for backward compatibility.
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   Usage:
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   - `corsHeadersFactory` is imported and used by multiple Supabase Edge Functions (`clarify-user-intent`, `generate-email-changes`, `manage-pending-changes`, `send-preview-email`) to set response headers for main requests, error responses, and OPTIONS preflight requests.
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   - The legacy `corsHeaders` is directly used for OPTIONS preflight request handling in `generate-email-changes/index.ts`.
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ uuid-utils.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   Purpose: Shared, canonical utility functions for validating and cleaning UUID strings.
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   Details: Provides `isValidUuid(id)` to check format via regex. Provides `cleanUuid(id)` to sanitize by removing trailing spaces/digits before validation.
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   Usage: Used across frontend/backend for UUID validation/sanitization, replacing previous duplicate implementations.
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ uuid.ts
â”‚   â”‚   â”‚   â”‚   â”‚       Purpose: Shared, canonical implementation for generating UUID v4 strings.
â”‚   â”‚   â”‚   â”‚   â”‚       Details: Uses `v4 as uuidv4` imported from a URL (`https://esm.sh/uuid`) for Deno/browser compatibility. A `@ts-ignore` comment is used to suppress a local TypeScript linter error related to resolving types from the URL, as Deno handles this at runtime. Exports `generateId()`.
â”‚   â”‚   â”‚   â”‚   â”‚       Usage: Standard way to generate unique IDs across the application (elements, sections, projects, etc.), replacing previous implementations that might have used direct npm package imports.
â”‚   â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“ services/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ğŸ“„ differ.ts
â”‚   â”‚   â”‚   â”‚       â”‚   Purpose: Backend-specific adapter for the V2 template diffing service.
â”‚   â”‚   â”‚   â”‚       â”‚   Details:
â”‚   â”‚   â”‚   â”‚       â”‚   - Extends `DifferV2Core` from `src/shared/services/differ.ts`.
â”‚   â”‚   â”‚   â”‚       â”‚   - Currently provides no backend-specific overrides, simply inherits core diffing logic.
â”‚   â”‚   â”‚   â”‚       â”‚   - Exports `DifferV2` class.
â”‚   â”‚   â”‚   â”‚       â”‚   Usage: Used internally by backend functions like `generate-email-changes` and `manage-pending-changes` when V2 diff calculations are needed.
â”‚   â”‚   â”‚   â”‚       â”‚
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ğŸ“„ htmlGenerator.ts
â”‚   â”‚   â”‚   â”‚       â”‚   Purpose: Backend adapter for the V2 HTML email generation service, extending `HtmlGeneratorCore`.
â”‚   â”‚   â”‚   â”‚       â”‚   Details:
â”‚   â”‚   â”‚   â”‚       â”‚   - Adapts `HtmlGeneratorCore` (from `src/shared/services/htmlGenerator.ts`) for the backend Deno environment.
â”‚   â”‚   â”‚   â”‚       â”‚   - Does not override any core methods, simply inherits the HTML generation logic.
â”‚   â”‚   â”‚   â”‚       â”‚   - **This means it includes the functionality from `HtmlGeneratorCore` to add `data-section-id` attributes to section containers, making these IDs available in the HTML stored in the database.**
â”‚   â”‚   â”‚   â”‚       â”‚   - Exports `HtmlGeneratorV2` class and a convenience `generateHtml(template)` function.
â”‚   â”‚   â”‚   â”‚       â”‚   Usage: Used by backend functions like `manage-pending-changes` to generate the final HTML for accepted email templates before saving to the database.
â”‚   â”‚   â”‚   â”‚       â”‚
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ ğŸ“„ semanticParser.ts 
â”‚   â”‚   â”‚   â”‚           Purpose: Backend adapter for V2 email HTML semantic parsing (if applicable, or if shared and used by backend).
â”‚   â”‚   â”‚   â”‚           Details: (Details would depend on its actual backend use)
â”‚   â”‚   â”‚   â”‚           Usage: (Usage would depend on its actual backend use)
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“ clarify-user-intent/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts
â”‚   â”‚   â”‚       Purpose: AI conversation middleware, served as a Supabase Edge Function.
â”‚   â”‚   â”‚       Details: (Content as previously listed, summarized for brevity)
â”‚   â”‚   â”‚       - Analyzes user messages, asks clarifying questions, provides structured data for email generation.
â”‚   â”‚   â”‚       - Manages context, token limits, error handling.
â”‚   â”‚   â”‚       Usage: HTTP POST endpoint for frontend, uses OpenAI.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“ generate-email-changes/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts
â”‚   â”‚   â”‚       Purpose: Supabase Edge Function to process AI-driven modifications to email templates, convert into granular pending changes, and save.
â”‚   â”‚   â”‚       Details: (Content as previously listed, summarized for brevity)
â”‚   â”‚   â”‚       - Receives payload, constructs OpenAI prompt for complete `EmailTemplateV2` (new or modified).
â”‚   â”‚   â”‚       - Parses AI response, merges with defaults, validates, generates batch ID.
â”‚   â”‚   â”‚       - Calls `convertDiffToGranularRows` to create `GranularPendingChangeInput[]`.
â”‚   â”‚   â”‚       - Saves granular changes to `pending_changes` table.
â”‚   â”‚   â”‚       Usage: Called by frontend after clarification to generate pending changes.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“ manage-pending-changes/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts
â”‚   â”‚   â”‚       Purpose: Supabase Edge Function to manage granular pending V2 template changes (accept/reject/get).
â”‚   â”‚   â”‚       Details: (Content as previously listed, summarized for brevity)
â”‚   â”‚   â”‚       - Handles `accept_one`, `reject_one`, `accept_batch`, `reject_batch`, `get_batch`, `get_all_project`.
â”‚   â”‚   â”‚       - Uses `applyPendingChanges` helper to modify `EmailTemplateV2`.
â”‚   â”‚   â”‚       - Regenerates HTML using `HtmlGeneratorV2` on acceptance.
â”‚   â”‚   â”‚       - Updates project's `semantic_email_v2`, `current_html`, and change statuses in DB.
â”‚   â”‚   â”‚       Usage: HTTP POST endpoint for frontend to manage pending changes.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“ send-preview-email/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts
â”‚   â”‚   â”‚       Purpose: Supabase Edge Function to send an email with provided HTML content for preview.
â”‚   â”‚   â”‚       Details: (Content as previously listed, summarized for brevity)
â”‚   â”‚   â”‚       - Accepts `recipientEmail` and `emailHtml`.
â”‚   â”‚   â”‚       - Uses `nodemailer` with Gmail SMTP (env var credentials) to send.
â”‚   â”‚   â”‚       Usage: HTTP POST endpoint for frontend to send preview emails.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“ save-email-setup-form/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ index.ts
â”‚   â”‚   â”‚   â”‚   Purpose: Supabase Edge Function to save user's initial email setup information.
â”‚   â”‚   â”‚   â”‚   Details:
â”‚   â”‚   â”‚   â”‚     - Receives form data (business area, goals, scenarios, default sender, domain, sendTimeline).
â”‚   â”‚   â”‚   â”‚     - Authenticates the user.
â”‚   â”‚   â”‚   â”‚     - Validates required fields like domain, defaultFromEmail, defaultFromName.
â”‚   â”‚   â”‚   â”‚     - Upserts data into the `email_setups` table (see "Database Schema" section for table details). Key fields set: user_id, domain, business_area, etc., status "pending_dns_config", send_timeline.
â”‚   â”‚   â”‚   â”‚     - Upserts/deletes `scenario_sender_configs` associated with the `email_setup_id`.
â”‚   â”‚   â”‚   â”‚   Usage: Called by the frontend when the user submits the initial email setup form.
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ types.ts  
â”‚   â”‚   â”‚       Purpose: Defines types and interfaces for save-email-setup-form.
â”‚   â”‚   â”‚       Details: Contains `EmailSetupFormData` and `ScenarioSenderConfig`.
â”‚   â”‚   â”‚       Usage: Used by `save-email-setup-form/index.ts`.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“ initiate-email-setup/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts
â”‚   â”‚   â”‚       Purpose: Orchestrates the initial DNS configuration steps for a user's domain. All configurations are manual. Primarily focuses on DKIM setup by calling an external mail server API.
â”‚   â”‚   â”‚       Details:
â”‚   â”‚   â”‚         - Authenticates the user and retrieves the `email_setups` record by ID (see "Database Schema" for table details).
â”‚   â”‚   â”‚         - **Idempotency Check:** If `dkim_public_key` column in `email_setups` table contains a valid Base64 key, it is reused.
â”‚   â”‚   â”‚         - **Calls External Mail Server API:**
â”‚   â”‚   â”‚           - Makes a POST request to `MAIL_SERVER_DKIM_ENDPOINT` (env var) with `{ domain }`. Expects `MAIL_SERVER_API_SECRET` (env var) for Bearer token authentication.
â”‚   â”‚   â”‚           - Expects the mail server to return a JSON response like `{ dnsTxtRecord: "selector._domainkey.domain IN TXT \"v=DKIM1; k=rsa; p=PUBLIC_KEY_BASE64\"" }`.
â”‚   â”‚   â”‚         - **DKIM Public Key Parsing & Validation:**
â”‚   â”‚   â”‚           - Parses the received `dnsTxtRecord` string (using regex) to extract the Base64 public key part (`p=...`).
â”‚   â”‚   â”‚           - Validates the extracted public key for valid Base64 format.
â”‚   â”‚   â”‚         - **DNS Record Generation:**
â”‚   â”‚   â”‚           - Generates required DNS records (MX, SPF TXT, DKIM TXT, DMARC TXT).
â”‚   â”‚   â”‚           - Uses `DEFAULT_MX_VALUE` (env var) or a fallback for the MX record value.
â”‚   â”‚   â”‚           - Uses `DEFAULT_SPF_VALUE` (env var) or a fallback for the SPF record value.
â”‚   â”‚   â”‚           - Uses `DEFAULT_DMARC_VALUE` (env var) or a fallback for the DMARC record value (e.g., `v=DMARC1; p=none; rua=mailto:dmarc-reports@domain.com`).
â”‚   â”‚   â”‚           - Constructs the DKIM TXT record value using the (parsed and validated) public key and a DKIM selector (uses existing `dkim_selector` from DB or defaults to "default"). If parsing/validation/API call fails, a placeholder error value is used in the DKIM DNS record.
â”‚   â”‚   â”‚         - **Database Update:** Updates the `email_setups` record (see "Database Schema" for table details) with fields including:
â”‚   â”‚   â”‚           - `dns_provider_name` (from user input).
â”‚   â”‚   â”‚           - `dns_setup_strategy` (always "manual").
â”‚   â”‚   â”‚           - `dkim_selector` (used or defaulted).
â”‚   â”‚   â”‚           - `dkim_public_key` (the extracted Base64 key, or `null` if provisioning failed).
â”‚   â”‚   â”‚           - `dns_records_to_set` (the generated DNS records).
â”‚   â”‚   â”‚           - `status` (always "awaiting_manual_dns_config").
â”‚   â”‚   â”‚           - `mx_record_value`, `spf_record_value`, `dmarc_record_value` are populated with the actual values used.
â”‚   â”‚   â”‚           - `mx_status`, `spf_status`, `dkim_status`, `dmarc_status`, `overall_dns_status` are initialized to 'pending'.
â”‚   â”‚   â”‚       Input: `{ emailSetupId: string, providerInfo: { name: string, nameservers: string[] } }`
â”‚   â”‚   â”‚       Output: `{ dnsSetupStrategy: "manual", dkimSelector: string, requiredDnsRecords: DnsRecord[], message: string }`
â”‚   â”‚   â”‚       Environment Variables Used: `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `MAIL_SERVER_DKIM_ENDPOINT`, `MAIL_SERVER_API_SECRET`, `DEFAULT_MX_VALUE`, `DEFAULT_SPF_VALUE`, `DEFAULT_DMARC_VALUE`.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“ verify-dns-records/
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts
â”‚   â”‚   â”‚       Purpose: Supabase Edge Function to verify DNS records (MX, SPF, DKIM, DMARC) for a given domain setup.
â”‚   â”‚   â”‚       Details:
â”‚   â”‚   â”‚         - Authenticates the user.
â”‚   â”‚   â”‚         - Accepts an `emailSetupId`.
â”‚   â”‚   â”‚         - Fetches the `email_setups` record to get the domain and expected DNS record values (`mx_record_value`, `spf_record_value`, `dmarc_record_value`, `dkim_public_key`, `dkim_selector`).
â”‚   â”‚   â”‚         - Uses `Deno.resolveDns(recordName, recordType)` to query actual DNS records from public resolvers.
â”‚   â”‚   â”‚         - **MX Check**: Compares the exchange part of resolved MX records against `mx_record_value`.
â”‚   â”‚   â”‚         - **SPF Check**: Looks for a TXT record starting with "v=spf1" that contains the `spf_record_value`.
â”‚   â”‚   â”‚         - **DKIM Check**: Looks for a TXT record at `dkim_selector._domainkey.domain` containing the `p=<dkim_public_key>`.
â”‚   â”‚   â”‚         - **DMARC Check**: Looks for a TXT record at `_dmarc.domain` starting with "v=DMARC1" that contains the `dmarc_record_value`.
â”‚   â”‚   â”‚         - Updates the `email_setups` table with the status for each record (`mx_status`, `spf_status`, `dkim_status`, `dmarc_status` - values: 'verified', 'failed', 'pending', 'error'), the `overall_dns_status`, `last_verification_attempt_at`, and `verification_failure_reason`.
â”‚   â”‚   â”‚         - Returns the detailed verification statuses.
â”‚   â”‚   â”‚       Input: `{ "emailSetupId": "uuid" }`
â”‚   â”‚   â”‚       Output: `{ overallDnsStatus, mxStatus, spfStatus, dkimStatus, dmarcStatus, lastVerificationAttemptAt, verificationFailureReason }` (see function interfaces for `DnsVerificationStatus` details).
â”‚   â”‚   â”‚       Environment Variables Used: `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_ANON_KEY`.
â”‚   â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ supabase-admin-example/  
â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts
â”‚   â”‚       Purpose: Example or utility function demonstrating Supabase admin client usage.
â”‚   â”‚       Details: (Content would depend on the specific example)
â”‚   â”‚       Usage: Reference for admin-level operations or a specific utility.
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“„ import_map.json 
â”‚       Purpose: Deno import map for backend functions if shared across all, or general backend utilities.
â”‚       Details: Maps module specifiers to URLs for Deno.
â”‚       Usage: Used by Deno runtime to resolve imports for functions not having their own `import_map.json` or for shared backend code.
â”‚
â”œâ”€â”€ ğŸ“ frontend/
â”‚   â”œâ”€â”€ ğŸ“ components/
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ EmailSetupForm.tsx
â”‚   â”‚   â”‚   Purpose: React component for the email setup onboarding form.
â”‚   â”‚   â”‚   Details:
â”‚   â”‚   â”‚   - Collects user input for business area, goals, scenarios, default sender info, domain.
â”‚   â”‚   â”‚   - Handles form submission, calling the `save-email-setup-form` Supabase function.
â”‚   â”‚   â”‚   - Likely includes state management for form fields and validation.
â”‚   â”‚   â”‚   Usage: Integrated into the onboarding flow pages.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DnsConfigurationGuide.tsx
â”‚   â”‚   â”‚   Purpose: React component to display DNS records and guide users on manual configuration.
â”‚   â”‚   â”‚   Details:
â”‚   â”‚   â”‚   - Takes DNS records (MX, SPF, DKIM, DMARC) as props.
â”‚   â”‚   â”‚   - Presents them clearly to the user.
â”‚   â”‚   â”‚   - May include instructions or links to common DNS provider help pages.
â”‚   â”‚   â”‚   Usage: Shown after `initiate-email-setup` returns, as all setups are manual.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Navbar.tsx
â”‚   â”‚   â”‚   Purpose: Navigation bar for the application, themed for the jungle look.
â”‚   â”‚   â”‚   Details: Provides main site navigation links. Styled with a dark green background, white text, and yellow accents to fit the jungle theme.
â”‚   â”‚   â”‚   Usage: Used in `Index.tsx` and potentially other authenticated pages.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Footer.tsx
â”‚   â”‚   â”‚   Purpose: Site-wide footer component, themed for the jungle look and compacted.
â”‚   â”‚   â”‚   Details:
â”‚   â”‚   â”‚   - Displays centered links for "Privacy Policy" and "Terms of Service".
â”‚   â”‚   â”‚   - Includes the centered text "a westwood innovation" in a smaller font below the links.
â”‚   â”‚   â”‚   - Styled with a dark background and reduced vertical padding.
â”‚   â”‚   â”‚   Usage: Used in `Index.tsx`.
â”‚   â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ contexts/
â”‚   â”‚   â””â”€â”€ ğŸ“„ EmailSetupContext.tsx
â”‚   â”‚       Purpose: React context to manage state related to the email setup process.
â”‚   â”‚       Details:
â”‚   â”‚       - Holds state like `emailSetupId`, form data, DNS records, current step.
â”‚   â”‚       - Provides functions to interact with backend (e.g., save form, initiate DNS setup).
â”‚   â”‚       Usage: Wraps parts of the application involved in email setup.
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ pages/
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Index.tsx
â”‚   â”‚   â”‚   Purpose: Main landing page component for the application.
â”‚   â”‚   â”‚   Details:
â”‚   â”‚   â”‚   - Serves as the entry point for users visiting the root URL.
â”‚   â”‚   â”‚   - Displays a jungle-themed layout (green background) with a themed main navigation bar.
â”‚   â”‚   â”‚   - Content area features a large `<textarea>` (no label) for business description input on the left, and a placeholder monkey image on the right.
â”‚   â”‚   â”‚   - The `<textarea>` has placeholder text "Explain your business. ex: An ecommerce store selling candles and soaps".
â”‚   â”‚   â”‚   - A button with text "make me an email marketing machine!" is displayed below the textarea.
â”‚   â”‚   â”‚   - The Hero, Features, and Testimonials sections have been removed.
â”‚   â”‚   â”‚   - Uses `@/components/Navbar` and `@/components/Footer`.
â”‚   â”‚   â”‚   Usage: Rendered at the root path ('/') for unauthenticated users.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ EmailOnboardingPage.tsx
â”‚   â”‚   â”‚   Purpose: Main page for the email setup onboarding flow.
â”‚   â”‚   â”‚   Details:
â”‚   â”‚   â”‚   - Likely orchestrates different steps of the onboarding (e.g., form, DNS config).
â”‚   â”‚   â”‚   - Uses `EmailSetupContext` and relevant components.
â”‚   â”‚   â”‚   Usage: Entry point for users setting up their email.
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ğŸ“„ DomainInput.tsx
â”‚   â”‚       Purpose: React page component for the multi-step email setup form, including domain input, DNS provider detection, display of DNS records, and DNS verification.
â”‚   â”‚       Details:
â”‚   â”‚       - Manages a multi-step form (business area, goals, scenarios, default sender, domain) using `currentStep` state.
â”‚   â”‚       - `formData` state stores all collected information.
â”‚   â”‚       - `handleSubmit` function:
â”‚   â”‚         - Calls `save-email-setup-form` Supabase function to save preferences and get an `emailSetupId`.
â”‚   â”‚         - Stores `emailSetupId` in state.
â”‚   â”‚         - Calls `get-domain-provider` Supabase function.
â”‚   â”‚         - Calls `initiate-email-setup` Supabase function to get DNS records.
â”‚   â”‚         - Displays required DNS records (`dnsRecordsToDisplay`) and provider-specific instructions (`currentProviderInstructions` from `dns-provider-instructions.ts`).
â”‚   â”‚       - **DNS Verification Logic:**
â”‚   â”‚         - State variables: `emailSetupId`, `verificationStatus` (object with `overall`, `mx`, `spf`, `dkim`, `dmarc` statuses), `isVerifying`, `lastVerificationTime`, `verificationError`.
â”‚   â”‚         - `handleVerifyDns` async function: Calls the `verify-dns-records` Supabase function, updates verification state, and shows toasts.
â”‚   â”‚         - `renderVerificationUI` function: Renders a status banner (color-coded by `verificationStatus.overall`), individual record statuses, last check time, errors, and a "Verify DNS Records" button with loading state.
â”‚   â”‚         - `useEffect` hook: 
â”‚   â”‚           - Triggers an initial call to `handleVerifyDns` if `emailSetupId` is present and verification hasn't started.
â”‚   â”‚           - Sets up a 5-minute polling interval to call `handleVerifyDns` if status is 'pending' or 'partially_verified'.
â”‚   â”‚           - Clears interval on unmount or if status is resolved/failed.
â”‚   â”‚       - Uses `@/components/ui/*` for UI elements and `@/hooks/use-toast` for notifications.
â”‚   â”‚       Usage: Central page for the user to input all initial email setup data and then view and verify their DNS configuration.
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ services/
â”‚   â”‚   â””â”€â”€ ğŸ“„ api.ts
â”‚   â”‚       Purpose: Frontend API service layer to interact with Supabase functions.
â”‚   â”‚       Details:
â”‚   â”‚       - Contains functions to call `save-email-setup-form` and `initiate-email-setup`.
â”‚   â”‚       - Handles Supabase client initialization, auth headers, error handling.
â”‚   â”‚       Usage: Used by components and context to communicate with the backend.
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“„ App.tsx 
â”‚       Purpose: Main application component.
â”‚       Details: Sets up routing, global providers (like EmailSetupContext).
â”‚       Usage: Root of the React application.
â”‚
â”œâ”€â”€ ğŸ“ shared/
â”‚   â”œâ”€â”€ ğŸ“ types/
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ emailSetupTypes.ts 
â”‚   â”‚   â”‚   Purpose: Shared type definitions for data structures used by both frontend and backend for email setup.
â”‚   â”‚   â”‚   Details:
â”‚   â”‚   â”‚   - `EmailSetupFormData` (if an identical structure is used, or a base type)
â”‚   â”‚   â”‚   - `ProviderInfo`
â”‚   â”‚   â”‚   - `DnsRecord`
â”‚   â”‚   â”‚   - `InitiateEmailSetupRequest` (or its parts if constructed on frontend)
â”‚   â”‚   â”‚   - `InitiateEmailSetupResponse` (or its parts)
â”‚   â”‚   â”‚   Usage: Imported by frontend components/services and backend Supabase functions.
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ pendingChangeTypes.ts
â”‚   â”‚   â”‚   Purpose: Defines types related to granular pending changes for V2 email templates.
â”‚   â”‚   â”‚   Details: Includes `GranularPendingChange`, `GranularPendingChangeInput`, `ChangeOperation`, `ChangeScope`, etc.
â”‚   â”‚   â”‚   Usage: Used by `generate-email-changes` and `manage-pending-changes` functions, and potentially by frontend components that display or interact with these changes.
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ğŸ“„ templateV2Types.ts
â”‚   â”‚       Purpose: Defines the core structure of V2 email templates.
â”‚   â”‚       Details: Includes `EmailTemplateV2`, `SectionV2`, `ElementV2`, and related style/property types. Uses Zod for validation.
â”‚   â”‚       Usage: Central type definition used by all services and functions that create, parse, modify, or render V2 email templates.
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ services/
â”‚       â”œâ”€â”€ ğŸ“„ differ.ts (Shared Core)
â”‚       â”‚   Purpose: Core logic for diffing V2 email templates.
â”‚       â”‚   Details: Provides `DifferV2Core` class with methods to compare two `EmailTemplateV2` objects and identify differences.
â”‚       â”‚   Usage: Extended by backend-specific (`src/backend/functions/_shared/services/differ.ts`) and potentially frontend-specific adapters.
â”‚       â”‚
â”‚       â”œâ”€â”€ ğŸ“„ htmlGenerator.ts (Shared Core)
â”‚       â”‚   Purpose: Core logic for generating HTML from V2 email templates.
â”‚       â”‚   Details: Provides `HtmlGeneratorCore` class with methods to convert an `EmailTemplateV2` object into an HTML string. Adds `data-section-id` attributes.
â”‚       â”‚   Usage: Extended by backend-specific (`src/backend/functions/_shared/services/htmlGenerator.ts`) and potentially frontend-specific adapters.
â”‚       â”‚
â”‚       â””â”€â”€ ğŸ“„ semanticParser.ts (Shared Core)
â”‚           Purpose: Core logic for parsing HTML into a V2 email template structure.
â”‚           Details: Provides `SemanticParserCore` class, defining the interface and shared utilities for converting HTML into `EmailTemplateV2`.
â”‚           Usage: Extended by frontend-specific (`src/frontend/services/semanticParser.ts` - if it exists) and potentially backend adapters.
â”‚
â””â”€â”€ ğŸ“„ .env.example
    Purpose: Example environment variables file.
    Details: Lists required environment variables for the project (Supabase URL/keys, API keys, etc.) with placeholder values.
    Usage: Users copy this to `.env` and fill in their actual credentials.

---
**Notes on Structure:**
- The sitemap had some duplicate entries or unclear nesting for `src/backend/.temp/` and `src/backend/functions/`. I've tried to rationalize this into a single main `src/backend/functions/` path for the Edge Functions.
- The `semanticParser.ts` under `src/backend/functions/_shared/services/` was noted as a "Frontend adapter" in the original read. I've kept it there but added a note. If it's purely for frontend, it should be in `src/frontend/services/`. If it's a shared core or a backend adapter, its description should reflect that. The one under `src/shared/services/` is correctly labeled as "Shared Core".
- Added placeholder entries for typical frontend files and a shared `emailSetupTypes.ts` based on the project's needs. These would need to be confirmed or created.
---

ğŸ“„ dns-provider-instructions.ts
   Purpose: Stores structured DNS setup instructions for various common DNS providers.
   Details:
     - Exports `DNS_PROVIDER_INSTRUCTIONS`: An array of `ProviderInstruction` objects.
     - Each `ProviderInstruction` contains:
       - `id`: Normalized string identifier (e.g., "cloudflare", "godaddy").
       - `displayName`: User-friendly provider name.
       - `logoUrl` (optional): Path/URL to a provider logo.
       - `dnsManagementUrl` (optional): Direct link to the provider's DNS management page.
       - `generalNotes` (optional): Array of general tips for the provider.
       - `instructionSteps`: Array of `ProviderInstructionStep` objects (title, description, optional link).
       - `uiFieldNames` (optional): Object mapping generic DNS field names (host, value, etc.) to provider-specific UI labels (e.g., "Name", "Content").
       - `recordSpecificTips` (optional): Object with tips for MX, TXT, SPF, DKIM, DMARC records.
     - Includes example data for Cloudflare, GoDaddy, and a generic "unknown" provider fallback.
     - Exports `getInstructionsForProvider(providerName)`: A helper function that takes a provider name string, normalizes it, and returns the corresponding `ProviderInstruction` object or the "unknown" provider instructions if not found.
   Usage: Intended to be imported by frontend components (e.g., a new DNS setup instructions page) to display tailored guidance to users based on their detected or selected DNS provider.

## Database Schema

This section outlines the structure of key tables in the Supabase PostgreSQL database.

### áˆ  Table: `email_setups`
Purpose: Stores information related to a user's email domain setup process. This includes initial configuration, DNS settings, and verification status.
Details:
  - `id`: `uuid` (Primary Key) - Unique identifier for the email setup record.
  - `user_id`: `uuid` (Foreign Key to `auth.users`) - The user who initiated this setup.
  - `domain`: `text` - The domain name the user is setting up (e.g., "example.com").
  - `business_area`: `text` - User-provided business area.
  - `business_subcategory`: `text` - User-provided business subcategory.
  - `goals`: `TEXT[]` (Array of text) - User-selected goals for using the email service.
  - `send_timeline`: `text` - User-indicated timeline for starting to send emails.
  - `dns_provider_name`: `text` - Name of the DNS provider (e.g., "Cloudflare", "GoDaddy").
  - `dns_setup_strategy`: `text` - The strategy for DNS setup (e.g., "manual", "automated"). Currently always "manual".
  - `default_from_name`: `text` - Default "From" name for emails sent from this domain.
  - `default_from_email`: `text` - Default "From" email address (e.g., "contact@example.com").
  - `email_scenarios`: `TEXT[]` (Array of text) - User-selected email scenarios.
  - `status`: `text` - General status of the email setup process (e.g., "pending_dns_config", "active", "error").
  - `dns_records_to_set`: `jsonb` - JSON object containing the DNS records the user needs to set (e.g., MX, SPF, DKIM, DMARC with host, type, value).
  - `provider_api_credentials_status`: `text` - Status related to DNS provider API credential validation (if applicable).
  - `error_message`: `text` - Stores any error message related to the setup process.
  - `created_at`: `timestamp with time zone` - Timestamp of creation.
  - `updated_at`: `timestamp with time zone` - Timestamp of last update.
  - **Existing DNS/DKIM Fields:**
    - `dkim_selector`: `text` - The DKIM selector used (e.g., "default").
    - `dkim_public_key`: `text` - The public part of the DKIM key (Base64 encoded).
  - **New Fields for DNS Record Values & Verification (Phase 1 Plan):**
    - `mx_record_value`: `TEXT` - Expected MX record value (e.g., "mx.yourmailserver.com").
    - `spf_record_value`: `TEXT` - Expected SPF record value (e.g., "v=spf1 include:yourmailserver.com ~all").
    - `dmarc_record_value`: `TEXT` - Expected DMARC record value (e.g., "v=DMARC1; p=none; rua=mailto:dmarc-reports@yourdomain.com").
    - `mx_status`: `TEXT` - Verification status for MX record (e.g., 'pending', 'verified', 'failed'). Default: 'pending'.
    - `spf_status`: `TEXT` - Verification status for SPF record. Default: 'pending'.
    - `dkim_status`: `TEXT` - Verification status for DKIM record. Default: 'pending'.
    - `dmarc_status`: `TEXT` - Verification status for DMARC record. Default: 'pending'.
    - `overall_dns_status`: `TEXT` - Overall DNS verification status (e.g., 'pending', 'partially_verified', 'verified', 'failed_to_verify'). Default: 'pending'.
    - `last_verification_attempt_at`: `TIMESTAMPTZ` - Timestamp of the last DNS verification attempt.
    - `verification_failure_reason`: `TEXT` - Stores any error message if the overall verification process fails.
Usage:
  - Read and written by `save-email-setup-form` to store initial data.
  - Read and updated by `initiate-email-setup` to store generated DNS records, DKIM key, and initialize verification statuses.
  - Will be read and updated by the new `verify-dns-records` function to check and store DNS verification statuses.
  - Read by frontend components to display setup progress and DNS instructions.
## PROJECT STRUCTURE MAP
